import { useState, useEffect, useCallback, useMemo } from 'react';
import { useNavigate } from 'react-router-dom';
import { salonAPI, serviceAPI } from '../../services/api';
import { Input } from '../../components/common/Input';
import { Button } from '../../components/common/Button';

// Hook personnalis√© pour charger les donn√©es du salon
const useSalonData = () => {
  const [salon, setSalon] = useState(null);
  const [services, setServices] = useState([]);
  const [categories, setCategories] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');

  const loadData = useCallback(async () => {
    try {
      setLoading(true);
      setError('');
      
      const salonRes = await salonAPI.getMySalon();
      const salonData = salonRes.data;
      
      if (!salonData) {
        throw new Error('Salon non trouv√©');
      }

      const [categoriesRes, servicesRes] = await Promise.all([
        serviceAPI.getAllCategories(),
        serviceAPI.getServicesBySalon(salonData.id, true)
      ]);
      
      setSalon(salonData);
      setCategories(categoriesRes.data);
      setServices(servicesRes.data);
    } catch (err) {
      console.error('Erreur lors du chargement:', err);
      setError(err.response?.data?.error || err.message || 'Erreur lors du chargement des donn√©es');
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    loadData();
  }, [loadData]);

  return { salon, services, setServices, categories, loading, error, setError, reload: loadData };
};

// Composant pour le formulaire de service
const ServiceForm = ({ 
  formData, 
  setFormData, 
  categories, 
  onSubmit, 
  onCancel, 
  submitting, 
  isEditing, 
  formErrors 
}) => (
  <div className="mb-8 bg-white rounded-lg shadow-sm border border-gray-200 p-6" role="form" aria-labelledby="form-title">
    <h2 id="form-title" className="text-xl font-bold mb-6">
      {isEditing ? 'Modifier le service' : 'Nouveau service'}
    </h2>
    
    <form onSubmit={onSubmit} className="space-y-6">
      <div>
        <label htmlFor="service-name" className="block text-sm font-medium text-gray-700 mb-2">
          Nom du service *
        </label>
        <Input
          id="service-name"
          type="text"
          value={formData.name}
          onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}
          placeholder="Ex: Coupe Homme"
          required
          disabled={submitting}
          aria-describedby={formErrors.name ? "name-error" : undefined}
        />
        {formErrors.name && <p id="name-error" className="text-red-500 text-sm">{formErrors.name}</p>}
      </div>

      <div>
        <label htmlFor="service-category" className="block text-sm font-medium text-gray-700 mb-2">
          Cat√©gorie *
        </label>
        <select
          id="service-category"
          value={formData.categoryId}
          onChange={(e) => setFormData(prev => ({ ...prev, categoryId: e.target.value }))}
          className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
          required
          disabled={submitting}
          aria-describedby={formErrors.categoryId ? "category-error" : undefined}
        >
          <option value="">S√©lectionner une cat√©gorie</option>
          {categories.map((category) => (
            <option key={category.id} value={category.id}>
              {category.icon} {category.name}
            </option>
          ))}
        </select>
        {formErrors.categoryId && <p id="category-error" className="text-red-500 text-sm">{formErrors.categoryId}</p>}
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div>
          <label htmlFor="service-duration" className="block text-sm font-medium text-gray-700 mb-2">
            Dur√©e (minutes)
          </label>
          <Input
            id="service-duration"
            type="number"
            min={5}
            step={5}
            value={formData.duration}
            onChange={(e) => setFormData(prev => ({ ...prev, duration: Number(e.target.value) }))}
            placeholder="30"
            disabled={submitting}
            aria-describedby={formErrors.duration ? "duration-error" : undefined}
          />
          {formErrors.duration && <p id="duration-error" className="text-red-500 text-sm">{formErrors.duration}</p>}
        </div>

        <div>
          <label htmlFor="service-price" className="block text-sm font-medium text-gray-700 mb-2">
            Prix (MAD)
          </label>
          <Input
            id="service-price"
            type="number"
            min={0}
            step={1}
            value={formData.price}
            onChange={(e) => setFormData(prev => ({ ...prev, price: Number(e.target.value) }))}
            placeholder="120"
            disabled={submitting}
            aria-describedby={formErrors.price ? "price-error" : undefined}
          />
          {formErrors.price && <p id="price-error" className="text-red-500 text-sm">{formErrors.price}</p>}
        </div>
      </div>

      <div>
        <label htmlFor="service-description" className="block text-sm font-medium text-gray-700 mb-2">
          Description
        </label>
        <textarea
          id="service-description"
          className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none resize-none"
          rows="3"
          value={formData.description}
          onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}
          placeholder="Ex: Coupe moderne avec finition..."
          disabled={submitting}
        />
      </div>

      <div className="flex gap-3 pt-4">
        <Button type="submit" loading={submitting} disabled={submitting}>
          {isEditing ? 'Mettre √† jour' : 'Ajouter'}
        </Button>
        <Button 
          type="button" 
          variant="secondary" 
          onClick={onCancel}
          disabled={submitting}
        >
          Annuler
        </Button>
      </div>
    </form>
  </div>
);

// Composant pour la liste des services
const ServiceList = ({ services, categories, onEdit, onDelete, submitting }) => {
  const servicesByCategory = useMemo(() => {
    if (!services.length || !categories.length) return {};
    
    const grouped = {};
    services.forEach(service => {
      const category = categories.find(cat => cat.id === service.categoryId);
      const categoryName = category ? category.name : 'Non cat√©goris√©';
      
      if (!grouped[categoryName]) {
        grouped[categoryName] = {
          category: category || { name: 'Non cat√©goris√©', icon: 'üì¶' },
          services: []
        };
      }
      grouped[categoryName].services.push(service);
    });
    return grouped;
  }, [services, categories]);

  if (services.length === 0) {
    return (
      <div className="text-center py-12">
        <div className="text-6xl mb-4">‚úÇÔ∏è</div>
        <p className="text-gray-600 mb-6">Aucun service ajout√©</p>
        <Button onClick={() => {}}>Ajouter votre premier service</Button>
      </div>
    );
  }

  return (
    <div className="space-y-8">
      {Object.entries(servicesByCategory).map(([categoryName, categoryData]) => (
        <div key={categoryName} className="border border-gray-200 rounded-lg p-6">
          <div className="flex items-center gap-3 mb-6 pb-4 border-b border-gray-100">
            <span className="text-2xl">{categoryData.category.icon}</span>
            <div>
              <h3 className="text-lg font-semibold text-gray-800">{categoryData.category.name}</h3>
              <p className="text-sm text-gray-500">
                {categoryData.services.length} service{categoryData.services.length > 1 ? 's' : ''}
              </p>
            </div>
          </div>
          <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
            {categoryData.services.map((service) => (
              <div key={service.id} className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow duration-200">
                <div className="flex justify-between items-start mb-3">
                  <h4 className="font-semibold text-gray-800 flex-1 pr-2">{service.name}</h4>
                  <div className="text-right ml-3">
                    <p className="font-bold text-purple-600">{service.price} MAD</p>
                    <p className="text-sm text-gray-600">{service.duration} min</p>
                  </div>
                </div>
                {service.description && (
                  <p className="text-sm text-gray-600 mb-4 line-clamp-2">{service.description}</p>
                )}
                <div className="flex gap-2 mt-auto">
                  <Button variant="secondary" onClick={() => onEdit(service)} className="flex-1 text-sm py-2" disabled={submitting}>
                    ‚úèÔ∏è Modifier
                  </Button>
                  <Button variant="danger" onClick={() => onDelete(service.id)} className="flex-1 text-sm py-2" disabled={submitting}>
                    üóëÔ∏è Supprimer
                  </Button>
                </div>
              </div>
            ))}
          </div>
        </div>
      ))}
    </div>
  );
};

export const SalonServices = () => {
  const navigate = useNavigate();
  const { salon, services, setServices, categories, loading, error, setError, reload } = useSalonData();
  
  const [showForm, setShowForm] = useState(false);
  const [editingService, setEditingService] = useState(null);
  const [submitting, setSubmitting] = useState(false);
  const [formData, setFormData] = useState({
    name: '',
    description: '',
    categoryId: '',
    duration: 30,
    price: 0
  });
  const [formErrors, setFormErrors] = useState({});

  const resetForm = useCallback(() => {
    setFormData({ name: '', description: '', categoryId: '', duration: 30, price: 0 });
    setEditingService(null);
    setShowForm(false);
    setFormErrors({});
  }, []);

  const validateForm = useCallback(() => {
    const errors = {};
    if (!formData.name.trim()) errors.name = 'Le nom est requis.';
    if (!formData.categoryId) errors.categoryId = 'La cat√©gorie est requise.';
    if (formData.duration < 5) errors.duration = 'La dur√©e doit √™tre d\'au moins 5 minutes.';
    if (formData.price < 0) errors.price = 'Le prix ne peut pas √™tre n√©gatif.';
    setFormErrors(errors);
    return Object.keys(errors).length === 0;
  }, [formData]);

  const handleEdit = useCallback((service) => {
    setEditingService(service);
    setFormData({
      name: service.name || '',
      description: service.description || '',
      categoryId: service.categoryId || '',
      duration: service.duration || 30,
      price: service.price || 0
    });
    setShowForm(true);
  }, []);

  const handleSubmit = useCallback(async (e) => {
    e.preventDefault();
    if (!validateForm()) return;
    
    setError('');
    setSubmitting(true);
    try {
      if (editingService) {
        const { data } = await serviceAPI.updateService(editingService.id, formData);
        setServices(prev => prev.map(s => s.id === data.id ? data : s));
      } else {
        const { data } = await serviceAPI.createService(salon.id, formData);
        setServices(prev => [...prev, data]);
      }
      resetForm();
    } catch (err) {
      console.error('Erreur lors de la sauvegarde:', err);
      setError(err.response?.data?.error || err.message || 'Erreur lors de la sauvegarde');
    } finally {
      setSubmitting(false);
    }
  }, [formData, editingService, salon, setServices, setError, resetForm, validateForm]);

  const handleDelete = useCallback(async (id) => {
    if (!window.confirm('√ätes-vous s√ªr de vouloir supprimer ce service ?')) return;
    try {
      await serviceAPI.deleteService(id);
      setServices(prev => prev.filter(s => s.id !== id));
    } catch (err) {
      console.error('Erreur lors de la suppression:', err);
      setError(err.response?.data?.error || err.message || 'Erreur lors de la suppression');
    }
  }, [setServices, setError]);

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50" aria-live="polite">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600" aria-label="Chargement en cours"></div>
      </div>
    );
  }

  return (
    <div className="flex-1 bg-gray-50">
      {/* Header */}
      <div className="bg-white shadow-sm border-b border-gray-200">
        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
          <div>
            <h1 className="text-2xl font-bold text-gray-900">‚úÇÔ∏è Gestion des Services</h1>
            <p className="text-sm text-gray-600">{salon?.name}</p>
          </div>
          <Button variant="secondary" onClick={() => navigate('/salon/dashboard')}>
            ‚Üê Retour
          </Button>
        </div>
      </div>

      {/* Main Content */}
      <div className="max-w-7xl mx-auto px-4 py-8">
        {error && (
          <div className="mb-6 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg" role="alert">
            <div className="flex items-center">
              <span className="mr-2">‚ö†Ô∏è</span>
              <span>{error}</span>
            </div>
          </div>
        )}

        {!showForm && (
          <div className="mb-6">
            <Button onClick={() => setShowForm(true)}>
              ‚ûï Ajouter un service
            </Button>
          </div>
        )}

        {/* Form */}
        {showForm && (
          <ServiceForm
            formData={formData}
            setFormData={setFormData}
            categories={categories}
            onSubmit={handleSubmit}
            onCancel={resetForm}
            submitting={submitting}
            isEditing={!!editingService}
            formErrors={formErrors}
          />
        )}

        {/* Services List */}
        <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <div className="flex justify-between items-center mb-6">
            <h2 className="text-xl font-bold text-gray-900">
              Services ({services.length})
            </h2>
            {categories.length > 0 && (
              <div className="text-sm text-gray-500">
                {categories.length} cat√©gories
              </div>
            )}
          </div>

          <ServiceList
            services={services}
            categories={categories}
            onEdit={handleEdit}
            onDelete={handleDelete}
            submitting={submitting}
          />
        </div>
      </div>
    </div>
  );
};