generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  CLIENT
  SALON_OWNER
  COIFFEUR
  CAISSIER
  ADMIN
  SUPER_ADMIN
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model User {
  id            String    @id @default(uuid())
  fullName      String    @map("full_name")
  email         String    @unique
  phone         String?   @unique
  role          Role      @default(CLIENT)
  passwordHash  String    @map("password_hash")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  salon         Salon?    @relation("SalonOwner")
  caissierSalon Salon?    @relation("SalonCaissier")
  coiffeur      Coiffeur? 
  rendezVous      RendezVous[]   @relation("ClientRendezVous")  
  reviewsGiven  Review[]  @relation("ClientReviews")
  clientScore   ClientScore? @relation("ClientScore")
  favorites     Favorite[] @relation("ClientFavorites")
  
  @@map("users")
}

model Salon {
  id          String         @id @default(uuid())
  ownerId     String         @unique @map("owner_id")
  caissierId  String?        @unique @map("caissier_id")
  name        String
  description String?
  address     String?
  city        String?
  postalCode  String?        @map("postal_code")
  country     String?        @default("Morocco")
  lat         Float?
  lng         Float?
  phone       String?
  email       String?
  website     String?
  type        SalonType      @default(MIXED)
  isActive    Boolean        @default(true) @map("is_active")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")
  
  owner       User           @relation("SalonOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  caissier    User?          @relation("SalonCaissier", fields: [caissierId], references: [id], onDelete: SetNull)
  images      SalonImage[]
  hours       SalonHours[]
  services    Service[]     // AJOUTER
  coiffeurs   Coiffeur[]    // AJOUTER
  rendezVous  RendezVous[]    // AJOUTER
  reviews     Review[]      @relation("SalonReviews")
  favorites   Favorite[]    @relation("SalonFavorites")

  @@map("salons")
}

model RendezVousService {
  id            String      @id @default(uuid())
  rendezVousId  String      @map("rendez_vous_id")
  serviceId     String      @map("service_id")
  
  rendezVous    RendezVous  @relation(fields: [rendezVousId], references: [id], onDelete: Cascade)
  service       Service     @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  @@unique([rendezVousId, serviceId])
  @@map("rendezvous_services")
}

model SalonImage {
  id          String    @id @default(uuid())
  salonId     String    @map("salon_id")
  url         String
  caption     String?
  isPrimary   Boolean   @default(false) @map("is_primary")
  order       Int       @default(0)
  createdAt   DateTime  @default(now()) @map("created_at")
  
  salon       Salon     @relation(fields: [salonId], references: [id], onDelete: Cascade)
  
  @@map("salon_images")
}

model SalonHours {
  id          String     @id @default(uuid())
  salonId     String     @map("salon_id")
  dayOfWeek   DayOfWeek  @map("day_of_week")
  openTime    String     @map("open_time")    // Format: "09:00"
  closeTime   String     @map("close_time")   // Format: "18:00"
  isClosed    Boolean    @default(false) @map("is_closed")
  
  salon       Salon      @relation(fields: [salonId], references: [id], onDelete: Cascade)
  
  @@unique([salonId, dayOfWeek])
  @@map("salon_hours")
}

model ServiceCategory {
  id          String    @id @default(uuid())
  name        String    @unique
  icon        String?
  description String?
  isActive    Boolean   @default(true) @map("is_active")
  sortOrder   Int       @default(0) @map("sort_order")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  services    Service[]
  
  @@map("service_categories")
}

model Service {
  id          String              @id @default(uuid())
  salonId     String              @map("salon_id")
  categoryId  String              @map("category_id")
  name        String
  description String?
  duration    Int
  price       Float
  isActive    Boolean             @default(true) @map("is_active")
  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")
  
  salon       Salon               @relation(fields: [salonId], references: [id], onDelete: Cascade)
  category    ServiceCategory     @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  rendezVous  RendezVous[]
  rdvServices RendezVousService[]  // AJOUTER
  
  @@map("services")
}

model Coiffeur {
  id          String    @id @default(uuid())
  salonId     String    @map("salon_id")
  userId      String?   @unique @map("user_id")
  fullName    String    @map("full_name")
  email       String?
  phone       String?
  specialty   String?
  bio         String?
  photo       String?
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // AJOUTER
  bufferMinutes Int     @default(5)

  salon       Salon     @relation(fields: [salonId], references: [id], onDelete: Cascade)
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  rendezVous      RendezVous[]
  disponibilites  DisponibiliteCoiffeur[]

  @@map("coiffeurs")
}
// Ajouter après le modèle Coiffeur

enum RendezVousStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
  LATE
}

enum Gender {
  MALE
  FEMALE
  OTHER
}



enum SalonType {
  MEN
  WOMEN
  MIXED
}

enum DayOfWeek_DUP {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model RendezVous {
  id          String            @id @default(uuid())
  clientId    String            @map("client_id")
  salonId     String            @map("salon_id")
  serviceId   String?           @map("service_id")
  coiffeurId  String?           @map("coiffeur_id")
  date        DateTime
  startTime   String            @map("start_time")
  endTime     String            @map("end_time")
  status      RendezVousStatus  @default(PENDING)
  isLateMarked Boolean          @default(false) @map("is_late_marked")
  notes       String?
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")
  totalDuration Int?   // NOUVEAU
  totalPrice    Decimal? @db.Decimal(10, 2) // NOUVEAU
  
  client      User              @relation("ClientRendezVous", fields: [clientId], references: [id], onDelete: Cascade)
  salon       Salon             @relation(fields: [salonId], references: [id], onDelete: Cascade)
  service     Service?          @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  coiffeur    Coiffeur?         @relation(fields: [coiffeurId], references: [id], onDelete: SetNull)
  services    RendezVousService[]

  @@index([clientId])
  @@index([salonId])
  @@index([coiffeurId])
  @@index([date])
  @@map("rendezvous")
}

model DisponibiliteCoiffeur {
  id          String     @id @default(uuid())
  coiffeurId  String     @map("coiffeur_id")
  dayOfWeek   DayOfWeek_DUP  @map("day_of_week")
  startTime   String     @map("start_time")  // Format: "09:00"
  endTime     String     @map("end_time")    // Format: "18:00"
  isAvailable Boolean    @default(true) @map("is_available")
  
  coiffeur    Coiffeur   @relation(fields: [coiffeurId], references: [id], onDelete: Cascade)
  
  @@unique([coiffeurId, dayOfWeek])
  @@map("disponibilites_coiffeur")
}

model Review {
  id        String   @id @default(uuid())
  clientId  String   @map("client_id")
  salonId   String   @map("salon_id")
  rating    Int      // 1 to 5
  comment   String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  client User   @relation("ClientReviews", fields: [clientId], references: [id], onDelete: Cascade)
  salon  Salon  @relation("SalonReviews", fields: [salonId], references: [id], onDelete: Cascade)

  @@unique([clientId, salonId]) // one review per client per salon
  @@map("reviews")
}

model Favorite {
  id        String   @id @default(uuid())
  clientId  String   @map("client_id")
  salonId   String   @map("salon_id")
  createdAt DateTime @default(now()) @map("created_at")

  client User  @relation("ClientFavorites", fields: [clientId], references: [id], onDelete: Cascade)
  salon  Salon @relation("SalonFavorites", fields: [salonId], references: [id], onDelete: Cascade)

  @@unique([clientId, salonId]) // one favorite per client per salon
  @@map("favorites")
}

// Client Scoring System
enum ClientLevel {
  RELIABLE
  NORMAL
  AT_RISK
}

enum EventType {
  NO_SHOW
  LATE
  LATE_CANCELLATION
  ON_TIME
  EARLY_CANCELLATION
  POSITIVE_REVIEW
  NEGATIVE_REVIEW
  FIRST_BOOKING
  REPEAT_BOOKING
}

model ClientScore {
  id        String      @id @default(uuid())
  clientId  String      @unique @map("client_id")
  score     Int         @default(100) // Base score 100
  level     ClientLevel @default(NORMAL)
  eventsCount Int       @default(0) @map("events_count")
  requiresDeposit Boolean @default(false) @map("requires_deposit")
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  client User           @relation("ClientScore", fields: [clientId], references: [id], onDelete: Cascade)
  events ClientEvent[]

  @@map("client_scores")
}

model ClientEvent {
  id         String    @id @default(uuid())
  clientId   String    @map("client_id")
  eventType  EventType @map("event_type")
  scoreChange Int       @map("score_change")
  metadata   Json?     // Additional event data (rdvId, reason, etc.)
  createdAt  DateTime  @default(now()) @map("created_at")

  client ClientScore @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("client_events")
}